import{a as g,i as P,g as $,b as x,c as T,p as j,m as J}from"./index.SVBtah2_.js";import{g as D,p as F,c as R,l as L,L as v,s as S,a as I}from"./getEthersSigner.DIrFHjWe.js";import{c as h,m as M,h as q}from"./wagmiConfig.Chk1Y_fx.js";import{s as A}from"./supabase.Cq5c-OsS.js";import{g as b}from"./getAccount.CrAKNmNJ.js";const z=g(""),Y=g(!1),O=g(""),C=g(null),_={env:"production",disablePersistenceEncryption:!0},Z=async t=>{let e=!1;if(P()){let a=null;m.value?.private_xmtp_address?a=m.value.private_xmtp_address:a=D();const o=F(a),n=R({account:o,chain:M,transport:q()}),i=n.account.address;if(e=L(i),!e){e=await v.getKeys(n,{..._}),S(i,e),t&&await fetch("/api/keys.json",{method:"POST",body:JSON.stringify({address:i.toLowerCase(),keys:Buffer.from(e).toString("hex")})});const d=b(h);localStorage.setItem(`xmtp-wallet-${d.address.toLowerCase()}`,a),await fetch("/api/contactbook.json",{method:"POST",body:JSON.stringify({wallet_address:d.address.toLowerCase(),xmtp_address:i.toLowerCase(),onesignal_subscription_id:$(),private_xmtp_address:a,name:O.get(),cookie:x()})})}}else{let a=await K();if(e=L(a.address),!e){e=await v.getKeys(a,{..._}),S(a.address,e),t&&await fetch("/api/keys.json",{method:"POST",body:JSON.stringify({address:proxyAddress.toLowerCase(),keys:Buffer.from(e).toString("hex")})});const o=b(h);await fetch("/api/contactbook.json",{method:"POST",body:JSON.stringify({wallet_address:o.address.toLowerCase(),xmtp_address:o.address.toLowerCase(),onesignal_subscription_id:$(),private_xmtp_address:`private-${o.address.toLowerCase()}`,name:O.get(),cookie:x()})})}}const s=await v.create(null,{..._,privateKeyOverride:e});s.registerCodec(new T),s.registerCodec(new j),console.log("xmtp",s),C.set(s)},K=async()=>{console.log("getting signer");let t=!1;try{t=await I(h),console.log(t);let e=await t.provider.getSigner();console.log(e),t=e}catch(e){console.log(e)}if(t)return t;setTimeout(async()=>{await K()},1e3)},m=g(null),ee=async()=>{const t=b(h);if(!t.address){m.set(null);return}const e=await fetch(`/api/wallet/${t.address.toLowerCase()}.json`,{method:"GET"}).then(s=>s.text()).then(s=>JSON.parse(s)).catch(s=>(console.log(s),null));if(P()&&e?.private_xmtp_address){const s=e.private_xmtp_address;localStorage.setItem(`xmtp-wallet-${t.address.toLowerCase()}`,s)}m.set(e)},l=g(!1),te=async(t,e)=>{const s=`campaign:${e?.id}`,a=await C.value.conversations.newConversation(t.owner_address.toLowerCase());try{await a.send(s),l.set(!l.value)}catch{l.set(!l.value)}},k="https://ojvozirqgxgiztlmasrm.supabase.co",se=async(t,e)=>{const s=`stamp:${t.token_address.toLowerCase()}:${e?.id}:${m.value.wallet_address.toLowerCase()}:${Date.now()}.png`,a=`enodedstamp:${t.token_address.toLowerCase()}:${e?.id}:${m.value.wallet_address.toLowerCase()}:${Date.now()}`,o="image/png",n=G(z.value,s,o);console.log("imagefile",n);const i=await new Promise((c,E)=>{const y=new FileReader;y.onload=()=>{y.result instanceof ArrayBuffer?c(y.result):E(new Error("Not an ArrayBuffer"))},y.readAsArrayBuffer(n)});console.log("imagedata",i);const d={filename:s,mimeType:o,data:new Uint8Array(i)},r=await j.encodeEncrypted(d,new T),w=await A.storage.from("stamps").upload(s,n,{upsert:!0}),u=await A.storage.from("stamps").upload(a,r.payload,{upsert:!0}),f=`${k}/storage/v1/object/public/${w.data.fullPath}`,p=`${k}/storage/v1/object/public/${u.data.fullPath}`;console.log("url",f);const N=await fetch("/api/uploadstamp.json",{method:"POST",body:JSON.stringify({url:f,encoded_url:p,wallet_address:m.value.wallet_address.toLowerCase(),campaign_id:e?.id,project_id:t.token_address.toLowerCase()})}).then(c=>c.text()).then(c=>JSON.parse(c)).catch(c=>(console.log(c),null));console.log("upload",N);const U={url:p,contentDigest:r.digest,salt:r.salt,nonce:r.nonce,secret:r.secret,scheme:"https://",filename:d.filename,contentLength:d.data.byteLength},B=await C.value.conversations.newConversation(t.owner_address.toLowerCase());try{await B.send(U,{contentType:J}),l.set(!l.value)}catch{l.set(!l.value)}},G=(t,e,s="image/jpg",a=512)=>{const o=atob(t.split(",")[1]),n=[];for(let r=0;r<o.length;r+=a){const w=o.slice(r,r+a),u=new Array(w.length);for(let p=0;p<w.length;p++)u[p]=w.charCodeAt(p);const f=new Uint8Array(u);n.push(f)}const i=new Blob(n,{type:s});return new File([i],`${e}.jpg`,{type:s})};export{m as $,Y as a,z as b,te as c,Z as d,O as e,C as f,l as g,ee as i,se as s};
