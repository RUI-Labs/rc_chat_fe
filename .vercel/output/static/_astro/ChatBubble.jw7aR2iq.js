import{b as k,d as V}from"./index.LclF5nvU.js";import{w as W,v as Z}from"./runtime-dom.esm-bundler.CkxCeCJQ.js";import{a as D,b as j,f as d,g as E,$ as h}from"./stamp.DRRuyw06.js";import{a as R}from"./anime.es.BNELU3II.js";import{m as N,p as Y,c as $}from"./index.SVBtah2_.js";import{_ as ee}from"./_plugin-vue_export-helper.DlAUqK2U.js";import{r,g as q,o as X,s as C,a as c,c as u,d as s,f as I,l as te,t as O,F as se,e as oe,w as ae,q as ne,n as S}from"./runtime-core.esm-bundler.C8n-v3-D.js";import"./getEthersSigner.DIrFHjWe.js";import"./wagmiConfig.Chk1Y_fx.js";import"./getConnectorClient.CvN7nnx2.js";import"./inherits_browser.BGXtg88A.js";import"./supabase.Cq5c-OsS.js";import"./getAccount.CrAKNmNJ.js";const re={__name:"ChatBubble",props:["project_info"],emits:["update"],setup(T,{expose:p,emit:z}){p();const a=r(null),L=r(null),A=r(null),o=r(null),B=r(""),{isOutside:v}=k(a),{isOutside:w}=k(L),F=r(null),_=r(!1),G=V(A),b=r([]),U=T,{project_info:l}=q(U);X(()=>{D.subscribe(t=>{console.log("showReceipt",t),_.value=t}),j.subscribe(t=>{F.value=t}),d.subscribe(async t=>{if(d.value){b.value=await d.value.conversations.list();let n=b.value.find(e=>e.peerAddress.toLowerCase()===l.value.owner_address.toLowerCase());console.log("exists",n);try{await d.value.conversations.newConversation(l.value.owner_address.toLowerCase())}catch(e){console.log("bypass bypass",e)}n||await g(),await g()}}),E.subscribe(()=>{console.log("$refreshMessages.value",E.value),g()})}),C(_,async()=>{if(_.value){let n=()=>new Promise((e,f)=>{let i=document.getElementById("whiteFlash");i?e(i):setTimeout(()=>{e(n())},100)});await n(),console.log("showing receipt"),R({targets:"#whiteFlash",opacity:0,duration:300,easing:"easeInOutSine"});var t=R.timeline({easing:"easeInOutSine",duration:300,delay:300});t.add({targets:"#receiptImage",scale:.8,rotate:"-6deg",duration:300}),t.add({targets:"#receiptImage",rotate:"0deg",width:"100px",height:"100px",complete:function(){let e=document.getElementById("receiptImage");e.style.transformOrigin="bottom right"},duration:500}),t.add({targets:"#receiptImage",translateY:"75vh",translateX:"60vw",duration:300,easing:"easeInOutSine"},"-=500"),t.add({targets:"#receiptImage",opacity:0,duration:600,easing:"easeInOutSine"},"-=500"),t.add({targets:"#blackDrop",opacity:0,duration:600,easing:"easeInOutSine"},"-=1000"),t.complete=()=>{D.set(!1),j.set(null)}}});const x=r(!1),H=()=>{x.value=!x.value,x.value&&o.value.focus()},M=z;C(v,()=>{M("update",v.value&&w.value)}),C(w,()=>{M("update",v.value&&w.value)});const m=r([]),J=t=>t==="me"?"text-right":"text-left",K=t=>t==="me"?"flex-row-reverse":"flex-row",y=r(!1),Q=async()=>{if(y.value)return;y.value=!0;let t=B.value;B.value="";try{await(await d.value.conversations.newConversation(l.value.owner_address.toLowerCase())).send(t)}catch(n){console.log("sendMessage",n)}m.value.length==0&&g(),y.value=!1},g=async()=>{m.value=[];let t=b.value.find(n=>n.peerAddress.toLowerCase()===l.value.owner_address.toLowerCase());if(console.log("selectedConversation",t),t){let n=await t.messages();console.log("_message",n),m.value=await Promise.all(n.map(async e=>{if(e.contentType.sameAs(N))try{const f=await Y.load(e.content,d.value);console.log("attachment",e,f);const i=URL.createObjectURL(new Blob([Buffer.from(f.data)],{type:f.mimeType}));return console.log("objectURL",i),{content:i,id:e.id,senderAddress:e.senderAddress,type:"attachment",sender:e.senderAddress.toLowerCase()==h.value.xmtp_address.toLowerCase()?"me":l.value.token_name}}catch{return{content:"",id:e.id,senderAddress:e.senderAddress,type:"media",sender:e.senderAddress.toLowerCase()==h.value.xmtp_address.toLowerCase()?"me":l.value.token_name}}else return{content:e.content,id:e.id,senderAddress:e.senderAddress,type:"text",sender:e.senderAddress.toLowerCase()==h.value.xmtp_address.toLowerCase()?"me":l.value.token_name}}));for await(const e of await t.streamMessages())m.value.find(i=>i.id===e.id)||m.value.push({content:e.content,id:e.id,senderAddress:e.senderAddress,type:"text",sender:e.senderAddress.toLowerCase()==h.value.xmtp_address.toLowerCase()?"me":l.value.token_name})}},P={chatbubbleEl:a,chatroomEl:L,sendButtonEl:A,sendMessageinput:o,messageInput:B,isOutsideChatToggle:v,isOutsideChatroom:w,receiptImageData:F,showReceipt:_,sendButtonElBounding:G,conversations:b,props:U,project_info:l,open:x,toggleChat:H,emit:M,messages:m,authorDirection:J,getDirection:K,isMessageBusy:y,sendMessage:Q,fetchMessages:g,get useMouseInElement(){return k},onMounted:X,ref:r,watch:C,toRefs:q,markRaw:ne,get useElementBounding(){return V},get $receiptImageData(){return j},get $showReceipt(){return D},get $xmtpClient(){return d},get $refreshMessages(){return E},get anime(){return R},get $userData(){return h},get ContentTypeRemoteAttachment(){return N},get RemoteAttachmentCodec(){return Y},get AttachmentCodec(){return $}};return Object.defineProperty(P,"__isScriptSetup",{enumerable:!1,value:!0}),P}},le={ref:"chatroomEl",class:"w-full h-full overflow-hidden"},ie={key:0,id:"snapshotParent",class:"w-screen h-screen top-0 left-0 z-50 fixed flex justify-center items-center"},de=s("div",{id:"whiteFlash",class:"bg-white w-full h-full absolute z-30"},null,-1),ce=["src"],ue=s("div",{id:"blackDrop",class:"bg-black/20 w-full h-full absolute z-10"},null,-1),pe={class:"w-full grid grid-cols-1 grid-rows-[auto_1fr_auto] h-full justify-center items-center"},me={class:"w-full p-2"},fe={class:"w-full bg-gray-100 rounded-xl p-2 flex justify-normal items-center space-x-2"},ge=s("div",{class:"h-12 w-12 rounded-xl bg-white border"},null,-1),he={class:"text-lg"},ve=s("span",{class:"p-1 bg-blue-500 px-2 rounded-xl text-white font-brand font-semibold"},"Yao",-1),we={class:"w-full h-full space-y-4 flex flex-col justify-end pb-4"},_e={key:0,class:"p-2 px-3 border rounded-xl"},be={key:1,class:"w-[100px] h-[100px] border rounded-md"},xe={key:2,class:"w-[100px] h-[100px] border rounded-md"},ye=["src"],Ce={class:"pr-2"},Ie={id:"sendButton",ref:"sendButtonEl",type:"submit",class:"w-12 h-12 flex justify-center items-center bg-green-500 shadow-md text-white rounded-xl hover:shadow-sm duration-300 hover:ring-2 hover:ring-green-500 hover:scale-90 active:scale-75 hover:ring-offset-2"},Le=s("iconify-icon",{class:"text-2xl",icon:"fluent:send-28-filled"},null,-1),Ae=[Le];function Be(T,p,z,a,L,A){return c(),u("div",le,[a.showReceipt?(c(),u("div",ie,[de,s("img",{id:"receiptImage",class:"w-full h-full z-20 border-8 border-blue-500 rounded-xl object-cover",src:a.receiptImageData,alt:""},null,8,ce),ue])):I("",!0),s("div",pe,[s("div",me,[s("div",fe,[ge,s("p",he,[ve,te(" from "+O(a.project_info.token_name),1)])])]),s("div",we,[(c(!0),u(se,null,oe(a.messages,o=>(c(),u("div",{class:S(["w-full flex px-2",[a.getDirection(o.sender)]])},[s("div",{class:S([a.getDirection(o.sender)])},[s("p",{class:S([a.authorDirection(o.sender),"w-full"])},O(o.sender),3),o.type=="text"?(c(),u("div",_e,O(o.content),1)):I("",!0),o.type=="media"?(c(),u("div",be)):I("",!0),o.type=="attachment"?(c(),u("div",xe,[s("img",{src:o.content},null,8,ye)])):I("",!0)],2)],2))),256))]),s("form",{onSubmit:p[1]||(p[1]=W(o=>a.sendMessage(),["prevent"])),class:"w-full border-t h-full border-t-gray-200 grid grid-cols-[1fr_auto] p-2"},[s("div",Ce,[ae(s("input",{"onUpdate:modelValue":p[0]||(p[0]=o=>a.messageInput=o),ref:"sendMessageinput",type:"text",class:"w-full h-full p-1 px-2 rounded-xl",placeholder:"Type a message..."},null,512),[[Z,a.messageInput]])]),s("button",Ie,Ae,512)],32)])],512)}const Ve=ee(re,[["render",Be]]);export{Ve as default};
